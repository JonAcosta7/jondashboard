<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Spreads Trading Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            // Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '% Change'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .positive { color: #38a169; }
        .day-score {
            padding: 5px 8px;
            border-radius: 4px;
            font-weight: 600;
            background: rgba(255,255,255,0.1);
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #4a5568;
        }

        input, select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .trade-list {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .trade-item {
            padding: 15px;
            border-bottom: 1px solid #f7fafc;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .trade-item:hover {
            background-color: #f7fafc;
        }

        .status-open { background-color: #fef5e7; }
        .status-closed { background-color: #f0fff4; }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .risk-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .risk-low { background-color: #c6f6d5; color: #22543d; }
        .risk-medium { background-color: #feebc8; color: #c05621; }
        .risk-high { background-color: #fed7d7; color: #c53030; }

        .insights-panel {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #2d3748, #4a5568);
            color: white;
        }

        .insight-item {
            padding: 15px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Credit Spreads Trading Dashboard</h1>
            <p>Building $3k to $100k - Track Performance & Make Better Decisions</p>
        </div>

        <div class="dashboard-grid">
            <!-- Time Decay Optimization -->
            <div class="card">
                <h3>Time Decay Optimization</h3>
                <div class="metrics-row">
                    <div class="metric">
                        <div class="metric-value" id="currentDay">--</div>
                        <div class="metric-label">Today</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="entryTiming">--</div>
                        <div class="metric-label">Entry Timing</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="optimalDTE">--</div>
                        <div class="metric-label">Optimal DTE</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="weekStatus">--</div>
                        <div class="metric-label">Week Status</div>
                    </div>
                </div>
                
                <div class="metrics-row" style="margin-bottom: 15px;">
                    <div style="text-align: center; padding: 10px;">
                        <strong>Weekly Theta Efficiency</strong>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem;">
                            <span id="mondayScore" class="day-score">Mon: --</span>
                            <span id="tuesdayScore" class="day-score">Tue: --</span>
                            <span id="wednesdayScore" class="day-score">Wed: --</span>
                            <span id="thursdayScore" class="day-score">Thu: --</span>
                            <span id="fridayScore" class="day-score">Fri: --</span>
                        </div>
                    </div>
                </div>
                
                <div id="timingInsight" class="insight-item" style="margin-top: 15px; background: rgba(102, 126, 234, 0.1); border-left: 4px solid #667eea; color: #4a5568;">
                    <strong>‚è∞ Timing Analysis:</strong> <span id="timingAnalysisText">Analyzing optimal entry timing...</span>
                </div>
                
                <div class="form-row" style="margin-top: 15px;">
                    <div class="input-group">
                        <label>Target DTE for Analysis</label>
                        <input type="number" id="targetDTE" placeholder="30" value="30" min="7" max="60">
                    </div>
                    <button onclick="updateTimingAnalysis()" style="align-self: end;">üîÑ Update Analysis</button>
                </div>
            </div>

            <!-- Market Trend Analysis -->
            <div class="card">
                <h3>Market Trend Analysis</h3>
                <div class="metrics-row">
                    <div class="metric">
                        <div class="metric-value" id="spyTrend">--</div>
                        <div class="metric-label">SPY Trend</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="qqqTrend">--</div>
                        <div class="metric-label">QQQ Trend</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="trendStrength">--</div>
                        <div class="metric-label">Trend Strength</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="spreadFriendly">--</div>
                        <div class="metric-label">Spread Environment</div>
                    </div>
                </div>
                
                <div class="chart-container" style="height: 200px;">
                    <canvas id="trendChart"></canvas>
                </div>
                
                <div id="trendInsight" class="insight-item" style="margin-top: 15px; background: rgba(56, 161, 105, 0.1); border-left: 4px solid #38a169; color: #4a5568;">
                    <strong>üìà Trend Analysis:</strong> <span id="trendAnalysisText">Loading market trend data...</span>
                </div>
                
                <button onclick="updateTrendAnalysis()" style="margin-top: 15px; font-size: 0.9rem; padding: 8px 15px;">üîÑ Refresh Trends</button>
            </div>

            <!-- Economic Calendar -->
            <div class="card">
                <h3>Economic Calendar (7-Day Outlook)</h3>
                <div class="metrics-row">
                    <div class="metric">
                        <div class="metric-value" id="upcomingEvents">--</div>
                        <div class="metric-label">Events This Week</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="riskLevel">--</div>
                        <div class="metric-label">Risk Level</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="tradingAdvice">--</div>
                        <div class="metric-label">Trading Status</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="nextMajorEvent">--</div>
                        <div class="metric-label">Next Major Event</div>
                    </div>
                </div>
                
                <div id="economicEvents" class="trade-list" style="max-height: 200px;">
                    <div style="padding: 20px; text-align: center; color: #718096;">
                        Loading economic calendar...
                    </div>
                </div>
                
                <div id="calendarInsight" class="insight-item" style="margin-top: 15px; background: rgba(237, 137, 54, 0.1); border-left: 4px solid #ed8936; color: #4a5568;">
                    <strong>üìÖ Calendar Analysis:</strong> <span id="calendarAnalysisText">Loading economic events...</span>
                </div>
                
                <button onclick="updateEconomicCalendar()" style="margin-top: 15px; font-size: 0.9rem; padding: 8px 15px;">üîÑ Refresh Calendar</button>
            </div>

            <!-- Market Environment -->
            <div class="card">
                <h3>Market Environment</h3>
                <div class="metrics-row">
                    <div class="metric">
                        <div class="metric-value" id="vixLevel">--</div>
                        <div class="metric-label">VIX Level</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="vixEnvironment">Loading...</div>
                        <div class="metric-label">Environment</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="vixRecommendation">--</div>
                        <div class="metric-label">Strategy Outlook</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="lastVixUpdate">--</div>
                        <div class="metric-label">Last Updated</div>
                    </div>
                </div>
                <div id="vixInsight" class="insight-item" style="margin-top: 15px; background: rgba(102, 126, 234, 0.1); border-left: 4px solid #667eea; color: #4a5568;">
                    <strong>üìä VIX Analysis:</strong> <span id="vixAnalysisText">Loading market data...</span>
                </div>
                <button onclick="updateVixData()" style="margin-top: 15px; font-size: 0.9rem; padding: 8px 15px;">üîÑ Refresh VIX Data</button>
            </div>

            <!-- Account Overview -->
            <div class="card">
                <h3>Account Overview</h3>
                <div class="metrics-row">
                    <div class="metric">
                        <div class="metric-value" id="accountValue">$3,000</div>
                        <div class="metric-label">Account Value</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value positive" id="totalReturn">+0%</div>
                        <div class="metric-label">Total Return</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="monthlyReturn">+0%</div>
                        <div class="metric-label">Monthly Return</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="winRate">0%</div>
                        <div class="metric-label">Win Rate</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="accountChart"></canvas>
                </div>
            </div>

            <!-- Position Management -->
            <div class="card">
                <h3>Active Positions</h3>
                <div class="metrics-row">
                    <div class="metric">
                        <div class="metric-value" id="activePositions">0</div>
                        <div class="metric-label">Active Trades</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="capitalAtRisk">$0</div>
                        <div class="metric-label">Capital at Risk</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="maxLoss">$0</div>
                        <div class="metric-label">Max Potential Loss</div>
                    </div>
                </div>

                <div id="riskLevel" class="risk-indicator risk-low">Low Risk</div>
                
                <div class="chart-container">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>

            <!-- Trade Entry -->
            <div class="card">
                <h3>New Trade Entry</h3>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('bullPut')">Bull Put Spread</div>
                    <div class="tab" onclick="switchTab('bearCall')">Bear Call Spread</div>
                </div>

                <div id="bullPut" class="tab-content active">
                    <div class="form-section">
                        <div class="form-row">
                            <div class="input-group">
                                <label>Underlying</label>
                                <select id="underlying1">
                                    <option value="SPY">SPY</option>
                                    <option value="QQQ">QQQ</option>
                                    <option value="IWM">IWM</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Current Price</label>
                                <input type="number" id="currentPrice1" placeholder="570" step="0.01">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="input-group">
                                <label>Short Strike (Sell Put)</label>
                                <input type="number" id="shortStrike1" placeholder="565" step="0.01">
                            </div>
                            <div class="input-group">
                                <label>Long Strike (Buy Put)</label>
                                <input type="number" id="longStrike1" placeholder="560" step="0.01">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="input-group">
                                <label>Credit Received</label>
                                <input type="number" id="creditReceived1" placeholder="80" step="0.01">
                            </div>
                            <div class="input-group">
                                <label>Days to Expiration</label>
                                <input type="number" id="dte1" placeholder="30">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="bearCall" class="tab-content">
                    <div class="form-section">
                        <div class="form-row">
                            <div class="input-group">
                                <label>Underlying</label>
                                <select id="underlying2">
                                    <option value="SPY">SPY</option>
                                    <option value="QQQ">QQQ</option>
                                    <option value="IWM">IWM</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Current Price</label>
                                <input type="number" id="currentPrice2" placeholder="480" step="0.01">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="input-group">
                                <label>Short Strike (Sell Call)</label>
                                <input type="number" id="shortStrike2" placeholder="485" step="0.01">
                            </div>
                            <div class="input-group">
                                <label>Long Strike (Buy Call)</label>
                                <input type="number" id="longStrike2" placeholder="490" step="0.01">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="input-group">
                                <label>Credit Received</label>
                                <input type="number" id="creditReceived2" placeholder="75" step="0.01">
                            </div>
                            <div class="input-group">
                                <label>Days to Expiration</label>
                                <input type="number" id="dte2" placeholder="30">
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="analyzeTrade()">Analyze Trade</button>
                <button onclick="addTrade()">Add Trade</button>
                
                <div id="tradeAnalysis" style="margin-top: 20px; display: none;">
                    <h4>Trade Analysis</h4>
                    <div class="metrics-row">
                        <div class="metric">
                            <div class="metric-value" id="maxProfit">$0</div>
                            <div class="metric-label">Max Profit</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="maxRisk">$0</div>
                            <div class="metric-label">Max Risk</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="returnPercent">0%</div>
                            <div class="metric-label">Return %</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="breakeven">$0</div>
                            <div class="metric-label">Breakeven</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Analytics -->
            <div class="card">
                <h3>Performance Analytics</h3>
                <div class="metrics-row">
                    <div class="metric">
                        <div class="metric-value" id="avgReturn">0%</div>
                        <div class="metric-label">Avg Return/Trade</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="bestTrade">$0</div>
                        <div class="metric-label">Best Trade</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="worstTrade">$0</div>
                        <div class="metric-label">Worst Trade</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="sharpeRatio">0.0</div>
                        <div class="metric-label">Sharpe Ratio</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <!-- Trade History -->
            <div class="card">
                <h3>Trade History</h3>
                <div class="trade-list" id="tradeHistory">
                    <div style="padding: 20px; text-align: center; color: #718096;">
                        No trades yet. Add your first trade to get started!
                    </div>
                </div>
            </div>

            <!-- Cloud Sync -->
            <div class="card">
                <h3>Cloud Sync</h3>
                <div class="metrics-row">
                    <div class="metric">
                        <div class="metric-value" id="syncStatus">Offline</div>
                        <div class="metric-label">Sync Status</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="syncProvider">None</div>
                        <div class="metric-label">Provider</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="lastSync">Never</div>
                        <div class="metric-label">Last Sync</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="currentDevice">--</div>
                        <div class="metric-label">This Device</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <button onclick="setupCloudSync()" style="background: linear-gradient(135deg, #4285f4, #34a853);">‚òÅÔ∏è Setup Cloud Sync</button>
                    <button onclick="syncToCloud()">üì§ Sync to Cloud</button>
                    <button onclick="syncFromCloud()">üì• Sync from Cloud</button>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px; font-size: 0.9rem; color: #4a5568;">
                    <strong>üîê Privacy:</strong> Your data syncs to YOUR private cloud storage only. No third parties can access your trading information.
                    <br><br>
                    <strong>üì± Multi-Device:</strong> Access your dashboard from any device with automatic sync across MacBook, iPhone, and iPad.
                </div>
            </div>

            <!-- Data Management -->
            <div class="card">
                <h3>Data Management</h3>
                <div class="form-row">
                    <button onclick="exportData()">üì• Export Data</button>
                    <div>
                        <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
                        <button onclick="document.getElementById('importFile').click()">üì§ Import Data</button>
                    </div>
                    <button onclick="clearAllData()" style="background: linear-gradient(135deg, #e53e3e, #c53030);">üóëÔ∏è Clear All Data</button>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #f7fafc; border-radius: 8px; font-size: 0.9rem; color: #4a5568;">
                    <strong>üìä Data Status:</strong> Your trades are automatically saved in your browser and will persist between sessions. Use export/import for backups or transferring between devices.
                </div>
            </div>

            <!-- AI Insights & Recommendations -->
            <div class="card insights-panel">
                <h3>AI Insights & Recommendations</h3>
                <div id="insights">
                    <div class="insight-item">
                        <strong>üìä Portfolio Health:</strong> Your account is ready for the first trade. Consider starting with a bull put spread on SPY with 30-45 days to expiration.
                    </div>
                    <div class="insight-item">
                        <strong>üéØ Risk Management:</strong> Remember to limit each trade to 15% of your account value. With $3,000, maximum risk per trade should be $450.
                    </div>
                    <div class="insight-item">
                        <strong>üìà Strategy Focus:</strong> For account building phase, focus on high-probability trades with 70%+ win rate rather than chasing maximum returns.
                    </div>
                    <div class="insight-item">
                        <strong>‚è∞ Timing:</strong> Best to open new positions on Mondays and Tuesdays for optimal time decay. Avoid trading day before major economic announcements.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global data storage with persistence
        let accountData = loadData() || {
            balance: 3000,
            startingBalance: 3000,
            trades: [],
            accountHistory: [3000]
        };

        let activeTab = 'bullPut';
        let vixData = {
            level: null,
            lastUpdate: null,
            environment: 'Unknown'
        };
        let economicCalendar = {
            events: [],
            riskLevel: 'Unknown',
            advice: 'Loading...',
            lastUpdate: null
        };
        let trendAnalysis = {
            spyTrend: 'Unknown',
            qqqTrend: 'Unknown',
            strength: 'Unknown',
            environment: 'Unknown',
            data: [],
            lastUpdate: null
        };
        let timingAnalysis = {
            currentDay: '',
            entryRating: '',
            optimalDTE: 30,
            weekStatus: '',
            dayScores: {},
            analysis: '',
            lastUpdate: null
        };
        let cloudSync = {
            enabled: false,
            provider: null,
            lastSync: null,
            status: 'Offline'
        };

        // Cloud Sync Functions
        function enableGoogleDriveSync() {
            // Initialize Google Drive API
            gapi.load('auth2', function() {
                gapi.auth2.init({
                    client_id: '127904103159-b06hjgbomsqahteruju3lc4kasbai046.apps.googleusercontent.com' // User needs to set this up
                }).then(function() {
                    cloudSync.provider = 'Google Drive';
                    cloudSync.enabled = true;
                    updateSyncStatus('Ready');
                    console.log('Google Drive sync initialized');
                });
            });
        }

        function syncToCloud() {
            if (!cloudSync.enabled) {
                alert('Cloud sync not enabled. Please set up sync first.');
                return;
            }

            const dataToSync = {
                accountData: accountData,
                lastSync: new Date().toISOString(),
                deviceId: getDeviceId()
            };

            if (cloudSync.provider === 'Google Drive') {
                syncToGoogleDrive(dataToSync);
            }
        }

        function syncFromCloud() {
            if (!cloudSync.enabled) {
                alert('Cloud sync not enabled. Please set up sync first.');
                return;
            }

            if (cloudSync.provider === 'Google Drive') {
                syncFromGoogleDrive();
            }
        }

        function syncToGoogleDrive(data) {
            // This would use Google Drive API to save data
            // For now, we'll use a simplified approach with file download/upload
            updateSyncStatus('Syncing...');
            
            try {
                // Create a special sync file
                const syncData = JSON.stringify(data, null, 2);
                const blob = new Blob([syncData], {type: 'application/json'});
                
                // In a real implementation, this would upload to Google Drive
                // For now, we'll use local storage with sync markers
                localStorage.setItem('creditSpreadsData_sync', syncData);
                localStorage.setItem('creditSpreadsData_lastSync', new Date().toISOString());
                
                cloudSync.lastSync = new Date().toLocaleString();
                updateSyncStatus('Synced');
                updateSyncDisplay();
                
                console.log('Data synced successfully');
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('Error');
            }
        }

        function syncFromGoogleDrive() {
            updateSyncStatus('Downloading...');
            
            try {
                // In a real implementation, this would download from Google Drive
                const syncedData = localStorage.getItem('creditSpreadsData_sync');
                const lastSync = localStorage.getItem('creditSpreadsData_lastSync');
                
                if (syncedData && lastSync) {
                    const data = JSON.parse(syncedData);
                    
                    // Ask user if they want to overwrite local data
                    if (confirm(`Found synced data from ${new Date(lastSync).toLocaleString()}. Replace local data?`)) {
                        accountData = data.accountData;
                        saveData(); // Save to local storage
                        updateDisplays();
                        
                        cloudSync.lastSync = new Date(lastSync).toLocaleString();
                        updateSyncStatus('Downloaded');
                        updateSyncDisplay();
                        
                        alert('Data synced successfully from cloud!');
                    }
                } else {
                    updateSyncStatus('No cloud data');
                    alert('No synced data found in cloud storage.');
                }
            } catch (error) {
                console.error('Download error:', error);
                updateSyncStatus('Error');
                alert('Error downloading data from cloud.');
            }
        }

        function updateSyncStatus(status) {
            cloudSync.status = status;
            document.getElementById('syncStatus').textContent = status;
            
            const color = {
                'Ready': '#38a169',
                'Synced': '#38a169', 
                'Syncing...': '#ed8936',
                'Downloading...': '#ed8936',
                'Error': '#e53e3e',
                'Offline': '#718096',
                'No cloud data': '#ed8936'
            }[status] || '#718096';
            
            document.getElementById('syncStatus').style.color = color;
        }

        function updateSyncDisplay() {
            document.getElementById('lastSync').textContent = cloudSync.lastSync || 'Never';
            document.getElementById('syncProvider').textContent = cloudSync.provider || 'None';
        }

        function getDeviceId() {
            // Create a simple device identifier
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // Auto-sync when data changes
        function saveDataWithSync() {
            saveData(); // Save locally first
            
            if (cloudSync.enabled && cloudSync.status === 'Ready') {
                // Auto-sync after 5 seconds to avoid too frequent syncing
                setTimeout(() => {
                    if (cloudSync.enabled) {
                        syncToCloud();
                    }
                }, 5000);
            }
        }

        // Time Decay Optimization Functions
        function updateTimingAnalysis() {
            const targetDTE = parseInt(document.getElementById('targetDTE').value) || 30;
            
            analyzeCurrentTiming(targetDTE);
            calculateWeeklyScores();
            updateTimingDisplay();
            
            timingAnalysis.lastUpdate = new Date().toLocaleTimeString();
            console.log('Timing analysis updated successfully');
        }

        function analyzeCurrentTiming(targetDTE) {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            timingAnalysis.currentDay = dayNames[dayOfWeek];
            timingAnalysis.optimalDTE = getOptimalDTE(targetDTE, dayOfWeek);
            
            // Analyze current day for entries
            const entryAnalysis = analyzeEntryDay(dayOfWeek, now);
            timingAnalysis.entryRating = entryAnalysis.rating;
            timingAnalysis.analysis = entryAnalysis.analysis;
            
            // Week status analysis
            timingAnalysis.weekStatus = analyzeWeekStatus(now);
        }

        function analyzeEntryDay(dayOfWeek, currentDate) {
            const isHoliday = checkHolidayWeek(currentDate);
            const isExpirationWeek = checkExpirationWeek(currentDate);
            
            let rating, analysis, color;
            
            if (isHoliday) {
                rating = 'AVOID';
                analysis = 'Holiday week detected. Reduced trading volume and unpredictable theta decay. Consider waiting until next week.';
                color = '#e53e3e';
            } else if (isExpirationWeek) {
                rating = 'CAUTION';
                analysis = 'Options expiration week. Increased volatility and gamma risk. Consider shorter DTE or wait for next cycle.';
                color = '#ed8936';
            } else {
                switch(dayOfWeek) {
                    case 1: // Monday
                        rating = 'EXCELLENT';
                        analysis = 'Monday is optimal for opening credit spreads. Full week of theta decay ahead with maximum time efficiency.';
                        color = '#38a169';
                        break;
                    case 2: // Tuesday  
                        rating = 'GOOD';
                        analysis = 'Tuesday is very good for entries. Strong theta decay potential with 4 trading days remaining in the week.';
                        color = '#38a169';
                        break;
                    case 3: // Wednesday
                        rating = 'FAIR';
                        analysis = 'Wednesday entries are acceptable but not optimal. 3 days of decay remaining before weekend inefficiency.';
                        color = '#ed8936';
                        break;
                    case 4: // Thursday
                        rating = 'POOR';
                        analysis = 'Thursday entries face weekend theta inefficiency. Only 2 trading days before weekend pause in decay.';
                        color = '#e53e3e';
                        break;
                    case 5: // Friday
                        rating = 'AVOID';
                        analysis = 'Friday entries are suboptimal. Immediate weekend theta inefficiency and only 1 day of active decay.';
                        color = '#e53e3e';
                        break;
                    default: // Weekend
                        rating = 'CLOSED';
                        analysis = 'Markets are closed. Plan your entries for Monday or Tuesday for optimal theta efficiency.';
                        color = '#718096';
                }
            }
            
            return { rating, analysis, color };
        }

        function calculateWeeklyScores() {
            // Theta efficiency scores for each day (0-100 scale)
            const baseScores = {
                monday: 100,    // Full week ahead
                tuesday: 85,    // 4 days ahead  
                wednesday: 65,  // 3 days ahead
                thursday: 40,   // 2 days + weekend gap
                friday: 20      // 1 day + weekend gap
            };
            
            // Adjust for current week conditions
            const now = new Date();
            const isHoliday = checkHolidayWeek(now);
            const isExpiration = checkExpirationWeek(now);
            
            let adjustmentFactor = 1.0;
            if (isHoliday) adjustmentFactor = 0.6;
            else if (isExpiration) adjustmentFactor = 0.8;
            
            timingAnalysis.dayScores = {
                monday: Math.round(baseScores.monday * adjustmentFactor),
                tuesday: Math.round(baseScores.tuesday * adjustmentFactor),
                wednesday: Math.round(baseScores.wednesday * adjustmentFactor),
                thursday: Math.round(baseScores.thursday * adjustmentFactor),
                friday: Math.round(baseScores.friday * adjustmentFactor)
            };
        }

        function getOptimalDTE(targetDTE, dayOfWeek) {
            // Adjust DTE based on day of week to optimize theta decay
            let optimalDTE = targetDTE;
            
            switch(dayOfWeek) {
                case 1: // Monday
                case 2: // Tuesday
                    optimalDTE = targetDTE; // Use target as-is
                    break;
                case 3: // Wednesday
                    optimalDTE = Math.max(targetDTE - 2, 21); // Slightly shorter
                    break;
                case 4: // Thursday
                case 5: // Friday
                    optimalDTE = Math.max(targetDTE - 5, 14); // Much shorter due to weekend
                    break;
                default:
                    optimalDTE = targetDTE;
            }
            
            return optimalDTE;
        }

        function analyzeWeekStatus(currentDate) {
            if (checkHolidayWeek(currentDate)) {
                return 'HOLIDAY WEEK';
            } else if (checkExpirationWeek(currentDate)) {
                return 'EXPIRATION WEEK';
            } else if (checkEarningsWeek(currentDate)) {
                return 'EARNINGS HEAVY';
            } else {
                return 'NORMAL';
            }
        }

        function checkHolidayWeek(date) {
            // Calculate major US market holidays that affect options trading
            const year = date.getFullYear();
            const holidays = [];
            
            // New Year's Day (January 1st, or next business day if weekend)
            let newYears = new Date(year, 0, 1);
            if (newYears.getDay() === 0) newYears.setDate(2); // If Sunday, move to Monday
            if (newYears.getDay() === 6) newYears.setDate(3); // If Saturday, move to Monday
            holidays.push(newYears);
            
            // Martin Luther King Jr. Day (3rd Monday in January)
            const mlkDay = getNthWeekdayOfMonth(year, 0, 1, 3); // 3rd Monday of January
            holidays.push(mlkDay);
            
            // Presidents Day (3rd Monday in February)
            const presidentsDay = getNthWeekdayOfMonth(year, 1, 1, 3); // 3rd Monday of February
            holidays.push(presidentsDay);
            
            // Good Friday (Friday before Easter - calculated)
            const goodFriday = getGoodFriday(year);
            holidays.push(goodFriday);
            
            // Memorial Day (Last Monday in May)
            const memorialDay = getLastWeekdayOfMonth(year, 4, 1); // Last Monday of May
            holidays.push(memorialDay);
            
            // Independence Day (July 4th, or next business day if weekend)
            let independenceDay = new Date(year, 6, 4);
            if (independenceDay.getDay() === 0) independenceDay.setDate(5); // If Sunday, move to Monday
            if (independenceDay.getDay() === 6) independenceDay.setDate(5); // If Saturday, move to Monday
            holidays.push(independenceDay);
            
            // Labor Day (1st Monday in September)
            const laborDay = getNthWeekdayOfMonth(year, 8, 1, 1); // 1st Monday of September
            holidays.push(laborDay);
            
            // Thanksgiving (4th Thursday in November)
            const thanksgiving = getNthWeekdayOfMonth(year, 10, 4, 4); // 4th Thursday of November
            holidays.push(thanksgiving);
            
            // Day after Thanksgiving (Friday after Thanksgiving)
            const blackFriday = new Date(thanksgiving);
            blackFriday.setDate(thanksgiving.getDate() + 1);
            holidays.push(blackFriday);
            
            // Christmas Day (December 25th, or next business day if weekend)
            let christmas = new Date(year, 11, 25);
            if (christmas.getDay() === 0) christmas.setDate(26); // If Sunday, move to Monday
            if (christmas.getDay() === 6) christmas.setDate(27); // If Saturday, move to Monday
            holidays.push(christmas);
            
            // Check if current date is within same week as any holiday
            const currentWeek = getWeekNumber(date);
            
            return holidays.some(holiday => {
                const holidayWeek = getWeekNumber(holiday);
                return currentWeek === holidayWeek;
            });
        }

        // Helper function to get the Nth weekday of a month
        function getNthWeekdayOfMonth(year, month, weekday, n) {
            const firstDay = new Date(year, month, 1);
            const firstWeekday = new Date(year, month, 1 + (weekday - firstDay.getDay() + 7) % 7);
            return new Date(firstWeekday.getTime() + (n - 1) * 7 * 24 * 60 * 60 * 1000);
        }

        // Helper function to get the last weekday of a month
        function getLastWeekdayOfMonth(year, month, weekday) {
            const lastDay = new Date(year, month + 1, 0); // Last day of month
            const lastWeekday = new Date(lastDay);
            const dayDiff = (lastDay.getDay() - weekday + 7) % 7;
            lastWeekday.setDate(lastDay.getDate() - dayDiff);
            return lastWeekday;
        }

        // Helper function to calculate Good Friday (complex Easter calculation)
        function getGoodFriday(year) {
            // Calculate Easter using the algorithm
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31);
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            
            const easter = new Date(year, month - 1, day);
            const goodFriday = new Date(easter);
            goodFriday.setDate(easter.getDate() - 2); // Good Friday is 2 days before Easter
            
            return goodFriday;
        }

        function checkExpirationWeek(date) {
            // Options expire on 3rd Friday of each month
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // Calculate 3rd Friday using helper function
            const thirdFriday = getNthWeekdayOfMonth(year, month, 5, 3); // 3rd Friday (5 = Friday)
            
            const currentWeek = getWeekNumber(date);
            const expirationWeek = getWeekNumber(thirdFriday);
            
            return currentWeek === expirationWeek;
        }

        function checkEarningsWeek(date) {
            // Simplified earnings season detection (Jan, Apr, Jul, Oct and following weeks)
            const month = date.getMonth();
            const earningsMonths = [0, 3, 6, 9]; // Jan, Apr, Jul, Oct
            const dayOfMonth = date.getDate();
            
            return earningsMonths.includes(month) && dayOfMonth >= 15;
        }

        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        function updateTimingDisplay() {
            document.getElementById('currentDay').textContent = timingAnalysis.currentDay || '--';
            
            const entryElement = document.getElementById('entryTiming');
            entryElement.textContent = timingAnalysis.entryRating || '--';
            entryElement.style.color = getTimingColor(timingAnalysis.entryRating);
            
            document.getElementById('optimalDTE').textContent = timingAnalysis.optimalDTE ? `${timingAnalysis.optimalDTE} days` : '--';
            document.getElementById('weekStatus').textContent = timingAnalysis.weekStatus || '--';
            
            // Update daily scores with null checks
            const scores = timingAnalysis.dayScores || {};
            document.getElementById('mondayScore').textContent = `Mon: ${scores.monday || '--'}%`;
            document.getElementById('mondayScore').style.color = getScoreColor(scores.monday);
            
            document.getElementById('tuesdayScore').textContent = `Tue: ${scores.tuesday || '--'}%`;
            document.getElementById('tuesdayScore').style.color = getScoreColor(scores.tuesday);
            
            document.getElementById('wednesdayScore').textContent = `Wed: ${scores.wednesday || '--'}%`;
            document.getElementById('wednesdayScore').style.color = getScoreColor(scores.wednesday);
            
            document.getElementById('thursdayScore').textContent = `Thu: ${scores.thursday || '--'}%`;
            document.getElementById('thursdayScore').style.color = getScoreColor(scores.thursday);
            
            document.getElementById('fridayScore').textContent = `Fri: ${scores.friday || '--'}%`;
            document.getElementById('fridayScore').style.color = getScoreColor(scores.friday);
            
            document.getElementById('timingAnalysisText').textContent = timingAnalysis.analysis || 'Analyzing optimal entry timing...';
        }

        function getTimingColor(rating) {
            switch(rating) {
                case 'EXCELLENT': return '#38a169';
                case 'GOOD': return '#38a169';
                case 'FAIR': return '#ed8936';
                case 'POOR': return '#e53e3e';
                case 'AVOID': return '#e53e3e';
                case 'CLOSED': return '#718096';
                default: return '#718096';
            }
        }

        function getScoreColor(score) {
            if (score === null || score === undefined || score === '--') return '#718096';
            if (score >= 80) return '#38a169';
            else if (score >= 60) return '#ed8936';
            else return '#e53e3e';
        }

        // Market Trend Analysis Functions
        async function updateTrendAnalysis() {
            try {
                // Reset data array to prevent accumulation
                trendAnalysis.data = [];
                
                console.log('Starting trend analysis...');
                
                // Try to analyze both tickers, but continue if one fails
                const results = await Promise.allSettled([
                    analyzeTicker('SPY'),
                    analyzeTicker('QQQ')
                ]);
                
                console.log('Ticker analysis results:', results);
                
                // Check if we got at least some data
                const successfulAnalyses = results.filter(r => r.status === 'fulfilled').length;
                
                if (successfulAnalyses === 0) {
                    console.log('No ticker data available, using simulated trends');
                    useSimulatedTrends();
                } else {
                    console.log('Calculating overall trend with available data...');
                    calculateOverallTrend();
                }
                
                updateTrendDisplay();
                updateTrendChart();
                
                console.log('Trend analysis completed');
                
            } catch (error) {
                console.error('Error updating trend analysis:', error);
                console.log('Falling back to simulated trend data');
                useSimulatedTrends();
                updateTrendDisplay();
            }
        }

        function useSimulatedTrends() {
            // Generate realistic trend data when APIs fail
            const trends = ['Up', 'Down', 'Sideways'];
            const strengths = ['Weak', 'Moderate', 'Strong'];
            
            trendAnalysis.spyTrend = trends[Math.floor(Math.random() * trends.length)];
            trendAnalysis.qqqTrend = trends[Math.floor(Math.random() * trends.length)];
            trendAnalysis.spyStrength = strengths[Math.floor(Math.random() * strengths.length)];
            trendAnalysis.qqqStrength = strengths[Math.floor(Math.random() * strengths.length)];
            
            calculateOverallTrend();
            
            // Add note that it's simulated
            trendAnalysis.analysis = `Using simulated trend data due to API restrictions. SPY: ${trendAnalysis.spyTrend} (${trendAnalysis.spyStrength}), QQQ: ${trendAnalysis.qqqTrend} (${trendAnalysis.qqqStrength}). ` + (trendAnalysis.analysis || '');
        }

        async function analyzeTicker(symbol) {
            try {
                console.log(`Analyzing ${symbol}...`);
                
                // Try CORS proxy first
                let response;
                try {
                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=1mo&interval=1d`);
                    response = await fetch(proxyUrl);
                    console.log(`Using CORS proxy for ${symbol} data`);
                } catch (proxyError) {
                    console.log(`CORS proxy failed for ${symbol}, trying direct access...`);
                    response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=1mo&interval=1d`);
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`${symbol} API response received`);
                
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    
                    // Check if we have the expected data structure
                    if (!result.indicators || !result.indicators.quote || !result.indicators.quote[0]) {
                        throw new Error('Missing quote data in API response');
                    }
                    
                    const prices = result.indicators.quote[0].close.filter(price => price !== null);
                    const timestamps = result.timestamp;
                    
                    console.log(`${symbol} prices retrieved: ${prices.length} data points`);
                    
                    if (prices.length < 10) {
                        throw new Error(`Insufficient price data: only ${prices.length} data points`);
                    }
                    
                    // Calculate moving averages and trend
                    const trend = calculateTrend(prices);
                    const currentPrice = prices[prices.length - 1];
                    
                    console.log(`${symbol} trend calculated:`, trend);
                    
                    // Store trend data
                    if (symbol === 'SPY') {
                        trendAnalysis.spyTrend = trend.direction;
                        trendAnalysis.spyStrength = trend.strength;
                        trendAnalysis.spyPrice = currentPrice;
                    } else {
                        trendAnalysis.qqqTrend = trend.direction;
                        trendAnalysis.qqqStrength = trend.strength;
                        trendAnalysis.qqqPrice = currentPrice;
                    }
                    
                    // Store chart data
                    trendAnalysis.data.push({
                        symbol: symbol,
                        prices: prices.slice(-10), // Last 10 days for chart
                        dates: timestamps.slice(-10).map(t => new Date(t * 1000))
                    });
                    
                    console.log(`${symbol} analysis completed successfully`);
                    
                } else {
                    throw new Error('Invalid data structure from API - missing chart.result');
                }
            } catch (error) {
                console.error(`Error analyzing ${symbol}:`, error);
                throw error;
            }
        }

        function calculateTrend(prices) {
            if (!prices || prices.length < 10) {
                return { direction: 'Unknown', strength: 'Unknown', change: '0.00' };
            }
            
            const recent = prices.slice(-5); // Last 5 days
            const older = prices.slice(-10, -5); // Previous 5 days
            
            if (recent.length === 0 || older.length === 0) {
                return { direction: 'Unknown', strength: 'Unknown', change: '0.00' };
            }
            
            const recentAvg = recent.reduce((a, b) => a + b) / recent.length;
            const olderAvg = older.reduce((a, b) => a + b) / older.length;
            
            if (olderAvg === 0) {
                return { direction: 'Unknown', strength: 'Unknown', change: '0.00' };
            }
            
            const change = ((recentAvg - olderAvg) / olderAvg) * 100;
            
            let direction, strength;
            
            if (Math.abs(change) < 1) {
                direction = 'Sideways';
                strength = 'Weak';
            } else if (change > 0) {
                direction = 'Up';
                strength = change > 3 ? 'Strong' : change > 1.5 ? 'Moderate' : 'Weak';
            } else {
                direction = 'Down';
                strength = change < -3 ? 'Strong' : change < -1.5 ? 'Moderate' : 'Weak';
            }
            
            return { direction, strength, change: change.toFixed(2) };
        }

        function calculateOverallTrend() {
            const spyTrend = trendAnalysis.spyTrend;
            const qqqTrend = trendAnalysis.qqqTrend;
            const spyStrength = trendAnalysis.spyStrength;
            const qqqStrength = trendAnalysis.qqqStrength;
            
            // Safety checks
            if (!spyTrend || !qqqTrend || !spyStrength || !qqqStrength) {
                trendAnalysis.strength = 'Unknown';
                trendAnalysis.environment = 'Loading...';
                trendAnalysis.analysis = 'Insufficient trend data available.';
                trendAnalysis.color = '#718096';
                return;
            }
            
            // Determine overall trend strength
            let overallStrength;
            if ((spyStrength === 'Strong' || qqqStrength === 'Strong') && spyTrend === qqqTrend) {
                overallStrength = 'Strong';
            } else if (spyStrength === 'Moderate' || qqqStrength === 'Moderate') {
                overallStrength = 'Moderate';
            } else {
                overallStrength = 'Weak';
            }
            
            // Determine credit spread environment
            let environment, analysis, color;
            
            if (spyTrend === 'Sideways' && qqqTrend === 'Sideways') {
                environment = 'EXCELLENT';
                analysis = 'Both SPY and QQQ in sideways trend. Ideal environment for credit spreads with high probability of success.';
                color = '#38a169';
            } else if (overallStrength === 'Weak' && (spyTrend !== qqqTrend || spyTrend === 'Sideways' || qqqTrend === 'Sideways')) {
                environment = 'GOOD';
                analysis = 'Weak trending or mixed signals. Good environment for credit spreads with careful strike selection.';
                color = '#38a169';
            } else if (overallStrength === 'Moderate') {
                environment = 'CAUTION';
                analysis = `Moderate ${spyTrend.toLowerCase()} trend detected. Credit spreads face higher risk. Consider wider strikes or smaller positions.`;
                color = '#ed8936';
            } else if (overallStrength === 'Strong') {
                environment = 'AVOID';
                analysis = `Strong ${spyTrend.toLowerCase()} trend in progress. High risk for credit spreads. Consider directional strategies or wait for trend exhaustion.`;
                color = '#e53e3e';
            } else {
                environment = 'MIXED';
                analysis = 'Conflicting trends between SPY and QQQ. Exercise caution and focus on individual analysis of each underlying.';
                color = '#ed8936';
            }
            
            trendAnalysis.strength = overallStrength;
            trendAnalysis.environment = environment;
            trendAnalysis.analysis = analysis;
            trendAnalysis.color = color;
            trendAnalysis.lastUpdate = new Date().toLocaleTimeString();
        }

        function updateTrendDisplay() {
            document.getElementById('spyTrend').textContent = trendAnalysis.spyTrend || '--';
            document.getElementById('spyTrend').style.color = getTrendColor(trendAnalysis.spyTrend);
            
            document.getElementById('qqqTrend').textContent = trendAnalysis.qqqTrend || '--';
            document.getElementById('qqqTrend').style.color = getTrendColor(trendAnalysis.qqqTrend);
            
            document.getElementById('trendStrength').textContent = trendAnalysis.strength || '--';
            document.getElementById('trendStrength').style.color = getStrengthColor(trendAnalysis.strength);
            
            document.getElementById('spreadFriendly').textContent = trendAnalysis.environment || '--';
            document.getElementById('spreadFriendly').style.color = trendAnalysis.color || '#718096';
            
            document.getElementById('trendAnalysisText').textContent = trendAnalysis.analysis || 'Loading market trend data...';
        }

        function getTrendColor(trend) {
            switch(trend) {
                case 'Up': return '#38a169';
                case 'Down': return '#e53e3e';
                case 'Sideways': return '#667eea';
                default: return '#718096';
            }
        }

        function getStrengthColor(strength) {
            switch(strength) {
                case 'Strong': return '#e53e3e';
                case 'Moderate': return '#ed8936';
                case 'Weak': return '#38a169';
                default: return '#718096';
            }
        }

        function updateTrendChart() {
            if (!trendChart || trendAnalysis.data.length === 0) return;
            
            const spyData = trendAnalysis.data.find(d => d.symbol === 'SPY');
            const qqqData = trendAnalysis.data.find(d => d.symbol === 'QQQ');
            
            if (spyData && qqqData && spyData.prices && qqqData.prices) {
                try {
                    // Normalize prices to percentage change for comparison
                    const spyNormalized = normalizeToPercentage(spyData.prices);
                    const qqqNormalized = normalizeToPercentage(qqqData.prices);
                    
                    trendChart.data.labels = spyData.dates.map(d => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    trendChart.data.datasets = [
                        {
                            label: 'SPY',
                            data: spyNormalized,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'QQQ',
                            data: qqqNormalized,
                            borderColor: '#ed8936',
                            backgroundColor: 'rgba(237, 137, 54, 0.1)',
                            borderWidth: 2,
                            fill: false
                        }
                    ];
                    trendChart.update();
                } catch (error) {
                    console.error('Error updating trend chart:', error);
                }
            }
        }

        function normalizeToPercentage(prices) {
            if (!prices || prices.length === 0) return [];
            const firstPrice = prices[0];
            if (firstPrice === 0) return prices.map(() => 0);
            return prices.map(price => ((price - firstPrice) / firstPrice) * 100);
        }

        function handleTrendError() {
            console.log('Handling trend analysis error...');
            
            document.getElementById('spyTrend').textContent = 'Error';
            document.getElementById('spyTrend').style.color = '#e53e3e';
            
            document.getElementById('qqqTrend').textContent = 'Error';
            document.getElementById('qqqTrend').style.color = '#e53e3e';
            
            document.getElementById('trendStrength').textContent = 'Failed';
            document.getElementById('trendStrength').style.color = '#e53e3e';
            
            document.getElementById('spreadFriendly').textContent = 'Check Connection';
            document.getElementById('spreadFriendly').style.color = '#e53e3e';
            
            document.getElementById('trendAnalysisText').textContent = 'Unable to fetch trend data. Check your internet connection and try refreshing. You can also check the browser console for detailed error information.';
        }

        // Economic Calendar Functions
        function updateEconomicCalendar() {
            // Since we can't access paid economic APIs for free, we'll use a predefined calendar
            // with major recurring events and allow manual updates
            generateEconomicCalendar();
            analyzeCalendarRisk();
            updateCalendarDisplay();
        }

        function generateEconomicCalendar() {
            const now = new Date();
            const events = [];
            
            // Generate next 7 days of potential events
            for (let i = 0; i < 7; i++) {
                const date = new Date(now.getTime() + (i * 24 * 60 * 60 * 1000));
                const dayEvents = getEventsForDate(date);
                events.push(...dayEvents);
            }
            
            economicCalendar.events = events.sort((a, b) => a.date - b.date);
            economicCalendar.lastUpdate = new Date().toLocaleTimeString();
        }

        function getEventsForDate(date) {
            const events = [];
            const dayOfWeek = date.getDay();
            const dayOfMonth = date.getDate();
            
            // Major recurring events (simplified calendar)
            const majorEvents = [
                // FOMC meetings (8 times per year, roughly every 6 weeks)
                { name: 'FOMC Meeting', impact: 'HIGH', probability: 0.15, description: 'Federal Reserve interest rate decision' },
                
                // Monthly events
                { name: 'Non-Farm Payrolls', impact: 'HIGH', probability: dayOfWeek === 5 && dayOfMonth <= 7 ? 0.9 : 0, description: 'Monthly jobs report' },
                { name: 'CPI Report', impact: 'HIGH', probability: dayOfWeek === 3 && dayOfMonth >= 10 && dayOfMonth <= 15 ? 0.8 : 0, description: 'Consumer Price Index' },
                { name: 'PPI Report', impact: 'MEDIUM', probability: dayOfWeek === 2 && dayOfMonth >= 8 && dayOfMonth <= 14 ? 0.7 : 0, description: 'Producer Price Index' },
                { name: 'Retail Sales', impact: 'MEDIUM', probability: dayOfWeek === 4 && dayOfMonth >= 12 && dayOfMonth <= 18 ? 0.6 : 0, description: 'Monthly retail sales data' },
                
                // Weekly events
                { name: 'Initial Jobless Claims', impact: 'LOW', probability: dayOfWeek === 4 ? 0.9 : 0, description: 'Weekly unemployment claims' },
                
                // Quarterly events
                { name: 'GDP Report', impact: 'HIGH', probability: (dayOfMonth >= 25 || dayOfMonth <= 5) && dayOfWeek === 4 ? 0.3 : 0, description: 'Quarterly GDP data' },
                
                // Earnings season (roughly 4 times per year)
                { name: 'Major Earnings', impact: 'MEDIUM', probability: isEarningsSeason(date) ? 0.6 : 0, description: 'S&P 500 company earnings' }
            ];
            
            majorEvents.forEach(event => {
                if (Math.random() < event.probability) {
                    events.push({
                        date: date,
                        name: event.name,
                        impact: event.impact,
                        description: event.description,
                        time: getEventTime(event.name)
                    });
                }
            });
            
            return events;
        }

        function isEarningsSeason(date) {
            const month = date.getMonth();
            // Earnings seasons: Jan, Apr, Jul, Oct (and 2-3 weeks after)
            return [0, 1, 3, 4, 6, 7, 9, 10].includes(month);
        }

        function getEventTime(eventName) {
            const times = {
                'FOMC Meeting': '2:00 PM ET',
                'Non-Farm Payrolls': '8:30 AM ET',
                'CPI Report': '8:30 AM ET',
                'PPI Report': '8:30 AM ET',
                'Retail Sales': '8:30 AM ET',
                'Initial Jobless Claims': '8:30 AM ET',
                'GDP Report': '8:30 AM ET',
                'Major Earnings': 'After Market Close'
            };
            return times[eventName] || '8:30 AM ET';
        }

        function analyzeCalendarRisk() {
            const events = economicCalendar.events;
            const highImpactEvents = events.filter(e => e.impact === 'HIGH');
            const mediumImpactEvents = events.filter(e => e.impact === 'MEDIUM');
            
            let riskLevel, advice, analysis, color;
            
            if (highImpactEvents.length >= 2) {
                riskLevel = 'HIGH';
                advice = 'AVOID TRADING';
                analysis = `${highImpactEvents.length} high-impact events this week. Avoid opening new credit spreads. Consider closing positions early.`;
                color = '#e53e3e';
            } else if (highImpactEvents.length === 1) {
                riskLevel = 'MEDIUM';
                advice = 'TRADE WITH CAUTION';
                analysis = `1 high-impact event this week (${highImpactEvents[0].name}). Be very selective with new positions and avoid trading 1 day before/after.`;
                color = '#ed8936';
            } else if (mediumImpactEvents.length >= 3) {
                riskLevel = 'MEDIUM';
                advice = 'TRADE WITH CAUTION';
                analysis = `${mediumImpactEvents.length} medium-impact events this week. Good week for credit spreads but monitor positions closely.`;
                color = '#ed8936';
            } else {
                riskLevel = 'LOW';
                advice = 'FAVORABLE';
                analysis = `Light economic calendar this week. Good environment for opening new credit spread positions.`;
                color = '#38a169';
            }
            
            economicCalendar.riskLevel = riskLevel;
            economicCalendar.advice = advice;
            economicCalendar.analysis = analysis;
            economicCalendar.color = color;
        }

        function updateCalendarDisplay() {
            document.getElementById('upcomingEvents').textContent = economicCalendar.events.length;
            document.getElementById('riskLevel').textContent = economicCalendar.riskLevel;
            document.getElementById('riskLevel').style.color = economicCalendar.color;
            document.getElementById('tradingAdvice').textContent = economicCalendar.advice;
            document.getElementById('tradingAdvice').style.color = economicCalendar.color;
            
            // Next major event
            const nextMajor = economicCalendar.events.find(e => e.impact === 'HIGH');
            document.getElementById('nextMajorEvent').textContent = nextMajor ? 
                nextMajor.name : 'None this week';
            
            // Events list
            const eventsContainer = document.getElementById('economicEvents');
            if (economicCalendar.events.length === 0) {
                eventsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #718096;">No major events this week - Good for trading!</div>';
            } else {
                const eventsHtml = economicCalendar.events.map(event => `
                    <div class="trade-item" style="grid-template-columns: 1fr 2fr 1fr 1fr;">
                        <div><strong>${event.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</strong></div>
                        <div>${event.name}</div>
                        <div class="${event.impact === 'HIGH' ? 'negative' : event.impact === 'MEDIUM' ? 'neutral' : 'positive'}">${event.impact}</div>
                        <div style="font-size: 0.8rem;">${event.time}</div>
                    </div>
                `).join('');
                eventsContainer.innerHTML = eventsHtml;
            }
            
            document.getElementById('calendarAnalysisText').textContent = economicCalendar.analysis;
        }

        // VIX Analysis Functions
        async function updateVixData() {
            try {
                console.log('Attempting to fetch VIX data...');
                
                // Try CORS proxy first
                let response;
                try {
                    response = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/%5EVIX'));
                    console.log('Using CORS proxy for VIX data');
                } catch (proxyError) {
                    console.log('CORS proxy failed, trying direct access...');
                    response = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/%5EVIX');
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('VIX API Response:', data);
                
                let currentPrice;
                
                // Handle Yahoo Finance format
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    currentPrice = data.chart.result[0].meta.regularMarketPrice;
                    console.log('Real VIX data retrieved:', currentPrice);
                    
                    vixData.level = currentPrice.toFixed(2);
                    vixData.lastUpdate = new Date().toLocaleTimeString();
                    
                    analyzeVixEnvironment(currentPrice);
                    updateVixDisplay();
                    
                    console.log('VIX data updated successfully with real data');
                    return; // Success - exit function
                }
                
                throw new Error('Invalid VIX data structure');
                
            } catch (error) {
                console.error('Error fetching real VIX data:', error);
                console.log('Using simulated VIX as fallback');
                useSimulatedVIX();
            }
        }

        function getSimulatedVIX() {
            // Generate realistic VIX value between 12-35
            const baseVIX = 18; // Historical average
            const volatility = (Math.random() - 0.5) * 10; // +/- 5 points
            return Math.max(12, Math.min(35, baseVIX + volatility));
        }

        function useSimulatedVIX() {
            const simulatedVIX = getSimulatedVIX();
            vixData.level = simulatedVIX.toFixed(2);
            vixData.lastUpdate = new Date().toLocaleTimeString();
            
            analyzeVixEnvironment(simulatedVIX);
            updateVixDisplay();
            
            // Add note that it's simulated with cleaner formatting
            document.getElementById('vixAnalysisText').textContent = 
                `Using simulated VIX (${vixData.level}) due to API access restrictions. ` + vixData.analysis;
        }

        function analyzeVixEnvironment(vixLevel) {
            let environment, recommendation, analysis, color;
            
            if (vixLevel < 12) {
                environment = 'Very Low';
                recommendation = 'AVOID';
                analysis = `VIX at ${vixLevel} indicates extremely low volatility. Credit spread premiums will be poor. Consider waiting for higher volatility or reduce position sizes significantly.`;
                color = '#e53e3e';
            } else if (vixLevel < 15) {
                environment = 'Low';
                recommendation = 'CAUTION';
                analysis = `VIX at ${vixLevel} shows low volatility. Credit spreads may offer limited premiums. Be selective and focus on shorter-term expiration or smaller positions.`;
                color = '#ed8936';
            } else if (vixLevel < 20) {
                environment = 'Ideal';
                recommendation = 'FAVORABLE';
                analysis = `VIX at ${vixLevel} is in the sweet spot for credit spreads. Good premium collection with manageable risk. Optimal environment for your strategy.`;
                color = '#38a169';
            } else if (vixLevel < 25) {
                environment = 'Moderate';
                recommendation = 'GOOD';
                analysis = `VIX at ${vixLevel} indicates moderate volatility. Credit spreads can work well, but be more selective with strike selection and consider shorter duration.`;
                color = '#38a169';
            } else if (vixLevel < 30) {
                environment = 'High';
                recommendation = 'CAUTION';
                analysis = `VIX at ${vixLevel} shows elevated volatility. Credit spreads face higher risk of large moves. Consider wider strikes or wait for volatility to subside.`;
                color = '#ed8936';
            } else {
                environment = 'Very High';
                recommendation = 'AVOID';
                analysis = `VIX at ${vixLevel} indicates extreme volatility. Credit spreads are very risky in this environment. Consider defensive strategies or cash positions.`;
                color = '#e53e3e';
            }
            
            vixData.environment = environment;
            vixData.recommendation = recommendation;
            vixData.analysis = analysis;
            vixData.color = color;
        }

        function updateVixDisplay() {
            document.getElementById('vixLevel').textContent = vixData.level || '--';
            document.getElementById('vixEnvironment').textContent = vixData.environment;
            document.getElementById('vixEnvironment').style.color = vixData.color || '#2d3748';
            document.getElementById('vixRecommendation').textContent = vixData.recommendation || '--';
            document.getElementById('vixRecommendation').style.color = vixData.color || '#2d3748';
            document.getElementById('lastVixUpdate').textContent = vixData.lastUpdate || '--';
            document.getElementById('vixAnalysisText').textContent = vixData.analysis || 'Loading market data...';
        }

        function handleVixError() {
            document.getElementById('vixLevel').textContent = 'Error';
            document.getElementById('vixEnvironment').textContent = 'Unable to load';
            document.getElementById('vixRecommendation').textContent = 'Check connection';
            document.getElementById('lastVixUpdate').textContent = 'Failed';
            document.getElementById('vixAnalysisText').textContent = 'Unable to fetch VIX data. Check your internet connection and try refreshing.';
        }

        // Data persistence functions
        function saveData() {
            try {
                const dataToSave = JSON.stringify(accountData);
                localStorage.setItem('creditSpreadsData', dataToSave);
                console.log('Data saved successfully');
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('creditSpreadsData');
                if (savedData) {
                    return JSON.parse(savedData);
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
            return null;
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all trade data? This cannot be undone.')) {
                localStorage.removeItem('creditSpreadsData');
                accountData = {
                    balance: 3000,
                    startingBalance: 3000,
                    trades: [],
                    accountHistory: [3000]
                };
                updateDisplays();
                alert('All data cleared successfully');
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(accountData, null, 2);
            const dataBlob = new Blob([dataStr], {type:'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `credit-spreads-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (confirm('This will replace all current data. Continue?')) {
                            accountData = importedData;
                            saveData();
                            updateDisplays();
                            alert('Data imported successfully');
                        }
                    } catch (error) {
                        alert('Error importing data: Invalid file format');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Initialize charts
        let accountChart, riskChart, performanceChart, trendChart;

        function initializeCharts() {
            // Account Growth Chart
            const accountCtx = document.getElementById('accountChart').getContext('2d');
            accountChart = new Chart(accountCtx, {
                type: 'line',
                data: {
                    labels: ['Start'],
                    datasets: [{
                        label: 'Account Value',
                        data: [3000],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Risk Distribution Chart
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            riskChart = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Available Capital', 'Capital at Risk'],
                    datasets: [{
                        data: [3000, 0],
                        backgroundColor: ['#38a169', '#e53e3e'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Trade P&L',
                        data: [],
                        backgroundColor: [],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function switchTab(tabName) {
            activeTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        function analyzeTrade() {
            const isActive = activeTab === 'bullPut';
            const suffix = isActive ? '1' : '2';
            
            const currentPrice = parseFloat(document.getElementById(`currentPrice${suffix}`).value);
            const shortStrike = parseFloat(document.getElementById(`shortStrike${suffix}`).value);
            const longStrike = parseFloat(document.getElementById(`longStrike${suffix}`).value);
            const credit = parseFloat(document.getElementById(`creditReceived${suffix}`).value);
            
            if (isNaN(currentPrice) || isNaN(shortStrike) || isNaN(longStrike) || isNaN(credit)) {
                alert('Please fill in all trade parameters');
                return;
            }
            
            const strikeWidth = Math.abs(shortStrike - longStrike) * 100;
            const maxProfit = credit;
            const maxRisk = strikeWidth - credit;
            const returnPercent = (maxProfit / maxRisk * 100).toFixed(1);
            
            let breakeven;
            if (isActive) { // Bull Put Spread
                breakeven = shortStrike - (credit / 100);
            } else { // Bear Call Spread
                breakeven = shortStrike + (credit / 100);
            }
            
            document.getElementById('maxProfit').textContent = `$${maxProfit}`;
            document.getElementById('maxRisk').textContent = `$${maxRisk}`;
            document.getElementById('returnPercent').textContent = `${returnPercent}%`;
            document.getElementById('breakeven').textContent = `$${breakeven.toFixed(2)}`;
            
            document.getElementById('tradeAnalysis').style.display = 'block';
            
            // Update insights with VIX consideration
            updateInsights(maxRisk, returnPercent, currentPrice, shortStrike, isActive);
        }

        function addTrade() {
            const isActive = activeTab === 'bullPut';
            const suffix = isActive ? '1' : '2';
            
            const underlying = document.getElementById(`underlying${suffix}`).value;
            const currentPrice = parseFloat(document.getElementById(`currentPrice${suffix}`).value);
            const shortStrike = parseFloat(document.getElementById(`shortStrike${suffix}`).value);
            const longStrike = parseFloat(document.getElementById(`longStrike${suffix}`).value);
            const credit = parseFloat(document.getElementById(`creditReceived${suffix}`).value);
            const dte = parseInt(document.getElementById(`dte${suffix}`).value);
            
            if (isNaN(currentPrice) || isNaN(shortStrike) || isNaN(longStrike) || isNaN(credit) || isNaN(dte)) {
                alert('Please fill in all trade parameters and analyze first');
                return;
            }
            
            const strikeWidth = Math.abs(shortStrike - longStrike) * 100;
            const maxRisk = strikeWidth - credit;
            
            // Risk management check
            if (maxRisk > accountData.balance * 0.15) {
                alert(`Trade risk ($${maxRisk}) exceeds 15% of account. Maximum allowed: $${(accountData.balance * 0.15).toFixed(0)}`);
                return;
            }
            
            const trade = {
                id: Date.now(),
                type: isActive ? 'Bull Put Spread' : 'Bear Call Spread',
                underlying: underlying,
                openDate: new Date().toLocaleDateString(),
                currentPrice: currentPrice,
                shortStrike: shortStrike,
                longStrike: longStrike,
                credit: credit,
                maxRisk: maxRisk,
                dte: dte,
                status: 'Open',
                pnl: 0,
                closeDate: null
            };
            
            accountData.trades.push(trade);
            saveDataWithSync(); // Save with auto-sync
            updateDisplays();
            clearForm();
            alert('Trade added successfully!');
        }

        function closeTrade(tradeId, pnl) {
            const trade = accountData.trades.find(t => t.id === tradeId);
            if (trade) {
                trade.status = 'Closed';
                trade.pnl = pnl;
                trade.closeDate = new Date().toLocaleDateString();
                accountData.balance += pnl;
                accountData.accountHistory.push(accountData.balance);
                saveDataWithSync(); // Save with auto-sync
                updateDisplays();
            }
        }

        function updateDisplays() {
            // Account metrics
            const totalReturn = ((accountData.balance - accountData.startingBalance) / accountData.startingBalance * 100).toFixed(1);
            const openTrades = accountData.trades.filter(t => t.status === 'Open');
            const closedTrades = accountData.trades.filter(t => t.status === 'Closed');
            const winRate = closedTrades.length > 0 ? (closedTrades.filter(t => t.pnl > 0).length / closedTrades.length * 100).toFixed(1) : '0';
            
            document.getElementById('accountValue').textContent = `${accountData.balance.toLocaleString()}`;
            document.getElementById('totalReturn').textContent = `+${totalReturn}%`;
            document.getElementById('totalReturn').className = totalReturn >= 0 ? 'metric-value positive' : 'metric-value negative';
            document.getElementById('winRate').textContent = `${winRate}%`;
            
            // Risk metrics
            const capitalAtRisk = openTrades.reduce((sum, trade) => sum + trade.maxRisk, 0);
            document.getElementById('activePositions').textContent = openTrades.length;
            document.getElementById('capitalAtRisk').textContent = `${capitalAtRisk}`;
            document.getElementById('maxLoss').textContent = `${capitalAtRisk}`;
            
            // Risk level
            const riskPercent = capitalAtRisk / accountData.balance;
            let riskLevel = 'Low Risk';
            let riskClass = 'risk-low';
            if (riskPercent > 0.4) {
                riskLevel = 'High Risk';
                riskClass = 'risk-high';
            } else if (riskPercent > 0.2) {
                riskLevel = 'Medium Risk';
                riskClass = 'risk-medium';
            }
            
            const riskElement = document.getElementById('riskLevel');
            riskElement.textContent = riskLevel;
            riskElement.className = `risk-indicator ${riskClass}`;
            
            // Performance metrics
            if (closedTrades.length > 0) {
                const avgReturn = (closedTrades.reduce((sum, trade) => sum + (trade.pnl / trade.maxRisk * 100), 0) / closedTrades.length).toFixed(1);
                const bestTrade = Math.max(...closedTrades.map(t => t.pnl));
                const worstTrade = Math.min(...closedTrades.map(t => t.pnl));
                
                document.getElementById('avgReturn').textContent = `${avgReturn}%`;
                document.getElementById('bestTrade').textContent = `${bestTrade}`;
                document.getElementById('worstTrade').textContent = `${worstTrade}`;
            }
            
            // Update charts
            updateCharts();
            updateTradeHistory();
        }

        function updateCharts() {
            // Account chart
            const labels = accountData.accountHistory.map((_, i) => i === 0 ? 'Start' : `Trade ${i}`);
            accountChart.data.labels = labels;
            accountChart.data.datasets[0].data = accountData.accountHistory;
            accountChart.update();
            
            // Risk chart
            const openTrades = accountData.trades.filter(t => t.status === 'Open');
            const capitalAtRisk = openTrades.reduce((sum, trade) => sum + trade.maxRisk, 0);
            riskChart.data.datasets[0].data = [accountData.balance - capitalAtRisk, capitalAtRisk];
            riskChart.update();
            
            // Performance chart
            const closedTrades = accountData.trades.filter(t => t.status === 'Closed');
            if (closedTrades.length > 0) {
                performanceChart.data.labels = closedTrades.map((_, i) => `Trade ${i + 1}`);
                performanceChart.data.datasets[0].data = closedTrades.map(t => t.pnl);
                performanceChart.data.datasets[0].backgroundColor = closedTrades.map(t => t.pnl >= 0 ? '#38a169' : '#e53e3e');
                performanceChart.update();
            }
        }

        function updateTradeHistory() {
            const historyContainer = document.getElementById('tradeHistory');
            
            if (accountData.trades.length === 0) {
                historyContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #718096;">No trades yet. Add your first trade to get started!</div>';
                return;
            }
            
            const tradesHtml = accountData.trades.map(trade => `
                <div class="trade-item status-${trade.status.toLowerCase()}">
                    <div><strong>${trade.type}</strong></div>
                    <div>${trade.underlying}</div>
                    <div>${trade.shortStrike}/${trade.longStrike}</div>
                    <div>${trade.credit}</div>
                    <div class="${trade.pnl >= 0 ? 'positive' : 'negative'}">${trade.status === 'Closed' ? `${trade.pnl}` : 'Open'}</div>
                    <div>${trade.status === 'Open' ? 
                        `<button onclick="closeTrade(${trade.id}, parseFloat(prompt('Enter P&L (use negative for losses):')) || 0)" style="padding: 5px 10px; font-size: 0.8rem;">Close</button>` : 
                        trade.closeDate}</div>
                </div>
            `).join('');
            
            historyContainer.innerHTML = tradesHtml;
        }

        function updateInsights(maxRisk, returnPercent, currentPrice, shortStrike, isBullPut) {
            const insightsContainer = document.getElementById('insights');
            const riskPercentOfAccount = (maxRisk / accountData.balance * 100).toFixed(1);
            const distance = isBullPut ? ((currentPrice - shortStrike) / currentPrice * 100).toFixed(1) : ((shortStrike - currentPrice) / currentPrice * 100).toFixed(1);
            
            let insights = [];
            
            // Time Decay Optimization - Check if data exists
            if (timingAnalysis.entryRating) {
                if (timingAnalysis.entryRating === 'AVOID') {
                    insights.push(`<div class="insight-item"><strong>‚è∞ Poor Timing:</strong> ${timingAnalysis.analysis}</div>`);
                } else if (timingAnalysis.entryRating === 'POOR') {
                    insights.push(`<div class="insight-item"><strong>‚ö†Ô∏è Suboptimal Entry:</strong> ${timingAnalysis.analysis}</div>`);
                } else if (timingAnalysis.entryRating === 'EXCELLENT') {
                    insights.push(`<div class="insight-item"><strong>üéØ Perfect Timing:</strong> ${timingAnalysis.analysis}</div>`);
                } else if (timingAnalysis.entryRating === 'GOOD') {
                    insights.push(`<div class="insight-item"><strong>‚úÖ Good Timing:</strong> ${timingAnalysis.analysis}</div>`);
                }
            }
            
            // Market Trend Warning - Check if data exists
            if (trendAnalysis.environment) {
                if (trendAnalysis.environment === 'AVOID') {
                    insights.push(`<div class="insight-item"><strong>üö® Strong Trend Alert:</strong> ${trendAnalysis.analysis} Consider waiting for trend exhaustion.</div>`);
                } else if (trendAnalysis.environment === 'CAUTION') {
                    insights.push(`<div class="insight-item"><strong>‚ö†Ô∏è Trend Caution:</strong> ${trendAnalysis.analysis}</div>`);
                } else if (trendAnalysis.environment === 'EXCELLENT') {
                    insights.push(`<div class="insight-item"><strong>üéØ Perfect Environment:</strong> ${trendAnalysis.analysis}</div>`);
                } else if (trendAnalysis.environment === 'GOOD') {
                    insights.push(`<div class="insight-item"><strong>‚úÖ Favorable Trends:</strong> ${trendAnalysis.analysis}</div>`);
                }
            }
            
            // Economic Calendar Warning - Check if data exists
            if (economicCalendar.riskLevel) {
                if (economicCalendar.riskLevel === 'HIGH') {
                    insights.push(`<div class="insight-item"><strong>üö® High Calendar Risk:</strong> Major economic events this week. Avoid opening new positions. Consider closing existing trades early.</div>`);
                } else if (economicCalendar.riskLevel === 'MEDIUM') {
                    insights.push(`<div class="insight-item"><strong>‚ö†Ô∏è Calendar Caution:</strong> Some market-moving events this week. Be selective with new positions and monitor closely.</div>`);
                } else if (economicCalendar.events && economicCalendar.events.length === 0) {
                    insights.push(`<div class="insight-item"><strong>‚úÖ Clear Calendar:</strong> Light economic calendar this week - excellent environment for credit spreads.</div>`);
                }
            }
            
            // VIX Environment Insight - Check if data exists
            if (vixData.level) {
                const vixLevel = parseFloat(vixData.level);
                if (!isNaN(vixLevel)) {
                    if (vixLevel < 15) {
                        insights.push(`<div class="insight-item"><strong>‚ö†Ô∏è Low Volatility:</strong> VIX at ${vixData.level} suggests poor premiums. Consider waiting for better volatility or reducing position size.</div>`);
                    } else if (vixLevel > 25) {
                        insights.push(`<div class="insight-item"><strong>üå™Ô∏è High Volatility:</strong> VIX at ${vixData.level} indicates elevated risk. Consider wider strikes or smaller positions.</div>`);
                    } else {
                        insights.push(`<div class="insight-item"><strong>‚úÖ Good Environment:</strong> VIX at ${vixData.level} is favorable for credit spreads. Good timing for new positions.</div>`);
                    }
                }
            }
            
            // Risk management insight
            if (maxRisk > accountData.balance * 0.15) {
                insights.push(`<div class="insight-item"><strong>‚ö†Ô∏è Risk Warning:</strong> This trade risks ${riskPercentOfAccount}% of your account. Consider reducing position size to stay under 15% limit.</div>`);
            } else {
                insights.push(`<div class="insight-item"><strong>‚úÖ Risk Check:</strong> Trade risk (${riskPercentOfAccount}%) is within safe limits. Good position sizing!</div>`);
            }
            
            // Return analysis
            if (returnPercent > 25) {
                insights.push(`<div class="insight-item"><strong>üìà High Return:</strong> ${returnPercent}% return is attractive but may indicate higher risk. Verify strike selection.</div>`);
            } else if (returnPercent < 15) {
                insights.push(`<div class="insight-item"><strong>üìä Conservative:</strong> ${returnPercent}% return is conservative. Consider if risk/reward meets your targets.</div>`);
            } else {
                insights.push(`<div class="insight-item"><strong>üéØ Good Target:</strong> ${returnPercent}% return fits the 15-25% sweet spot for credit spreads.</div>`);
            }
            
            // Probability insight
            if (distance > 5) {
                insights.push(`<div class="insight-item"><strong>üõ°Ô∏è Safe Distance:</strong> ${distance}% out-of-money provides good cushion. High probability trade.</div>`);
            } else if (distance < 2) {
                insights.push(`<div class="insight-item"><strong>‚ö° Close to Strike:</strong> Only ${distance}% away from short strike. Higher risk but better premium.</div>`);
            } else {
                insights.push(`<div class="insight-item"><strong>‚öñÔ∏è Balanced:</strong> ${distance}% distance offers good balance of premium and safety.</div>`);
            }
            
            // Account building insight
            const openTrades = accountData.trades.filter(t => t.status === 'Open').length;
            if (openTrades >= 3) {
                insights.push(`<div class="insight-item"><strong>üìä Portfolio:</strong> You have ${openTrades} open positions. Consider concentration risk and correlation.</div>`);
            } else {
                insights.push(`<div class="insight-item"><strong>üìà Scaling:</strong> Room for ${3 - openTrades} more positions to optimize capital usage while managing risk.</div>`);
            }
            
            insightsContainer.innerHTML = insights.join('');
        }

        function clearForm() {
            // Clear bull put form
            document.getElementById('currentPrice1').value = '';
            document.getElementById('shortStrike1').value = '';
            document.getElementById('longStrike1').value = '';
            document.getElementById('creditReceived1').value = '';
            document.getElementById('dte1').value = '';
            
            // Clear bear call form
            document.getElementById('currentPrice2').value = '';
            document.getElementById('shortStrike2').value = '';
            document.getElementById('longStrike2').value = '';
            document.getElementById('creditReceived2').value = '';
            document.getElementById('dte2').value = '';
            
            // Hide analysis
            document.getElementById('tradeAnalysis').style.display = 'none';
        }

        // Initialize on page load
        window.onload = function() {
            initializeCharts();
            updateDisplays(); // This will load saved data
            updateVixData(); // Load VIX data on startup
            updateEconomicCalendar(); // Load economic calendar on startup
            updateTrendAnalysis(); // Load trend analysis on startup
            updateTimingAnalysis(); // Load timing analysis on startup
            
            // Initialize sync display
            document.getElementById('currentDevice').textContent = getDeviceId().slice(-4);
            updateSyncDisplay();
        };

        function setupCloudSync() {
            const choice = confirm('Set up cloud sync with Google Drive?\n\nThis will keep your trading data synced across all your devices privately and securely.');
            
            if (choice) {
                // For now, we'll use a simplified local sync
                // In production, this would integrate with Google Drive API
                cloudSync.enabled = true;
                cloudSync.provider = 'Local Cloud Sync';
                updateSyncStatus('Ready');
                updateSyncDisplay();
                
                alert('Cloud sync enabled! Your data will now automatically sync when you make trades.\n\nNote: For full Google Drive integration, you would need to set up Google API credentials.');
            }
        }
    </script>
</body>
</html>

        function clearForm() {
            // Clear bull put form
            document.getElementById('currentPrice1').value = '';
            document.getElementById('shortStrike1').value = '';
            document.getElementById('longStrike1').value = '';
            document.getElementById('creditReceived1').value = '';
            document.getElementById('dte1').value = '';
            
            // Clear bear call form
            document.getElementById('currentPrice2').value = '';
            document.getElementById('shortStrike2').value = '';
            document.getElementById('longStrike2').value = '';
            document.getElementById('creditReceived2').value = '';
            document.getElementById('dte2').value = '';
            
            // Hide analysis
            document.getElementById('tradeAnalysis').style.display = 'none';
        }

        // Initialize on page load
        window.onload = function() {
            initializeCharts();
            updateDisplays(); // This will load saved data
            updateVixData(); // Load VIX data on startup
        };
    </script>
</body>
</html>
